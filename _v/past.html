@require(events)
<div class="col_12">
	<div class="row bold">
		<div class="col_2">Date</div>
		<div class="col_2">Home team</div>
		<div class="col_2">Visitor team</div>
		<div class="col_2">League</div>
		<div class="col_1">Video</div>
		<div class="col_3">
			<div class="cw_4 right"> 
				&nbsp;
			</div>
			<div class="cw_4 right"> 
				<button id="download" class="green small cw_12" type="reset">
					<i class="icon-download-alt"></i>
				</button>
			</div>
			<div class="cw_1 right"> 
				<input type="checkbox" control="chkAll" class="chkAll">
			</div>
			<div class="cw_3" style="float:right;">
				<button class="removeSel small red cw_12">
					<i class="icon-remove"></i>
				</button>
			</div>
		</div>
	</div>	
@for ev in events:
	<div class="row border-top">
		<div class="col_2">
			@ev['date']
		</div>
		<div class="col_2 word-break">
			@ev['homeTeam']
		</div>
		<div class="col_2 word-break">
			@ev['visitTeam']
		</div>
		<div class="col_2 word-break">
			@ev['league']
		</div>
		<div class="col_2 vidColumn">
			@if 'mp4' in ev:
				<a class="media" href="@ev['mp4']">play</a> (@ev['size_fmt'])
			@elif 'live' in ev:
				<a class="media" href="@ev['live']">live</a>
			@else:
				n/a
			@end
		</div>
		<div class="col_2">
			<div class="cw_1 right backup-holder">
				<a href="#" class="backupEvt large" eventID="@ev['hid']"><i class="icon-save"></i></a>
			</div>
			<div class="cw_10 center">
				@if 'mp4' in ev:
					<input type="checkbox" class="center" event="@ev['name']" eventID="@ev['hid']" download>
				@elif not 'live' in ev:
					<input type="checkbox" class="center" event="@ev['name']" eventID="@ev['hid']">
				@end
			</div>
			<div class="cw_1 right">
				@if not 'live' in ev:
					<a href="#" class="removeEvt large red" event="@ev['name']" eventID="@ev['hid']"><i class="icon-remove"></i></a>
				@end
			</div>
		</div>
	</div>
@end
</div>
<div id="videoWnd" class="wnd-container hide">
	<div class="wnd">
		<video id="videoPlayer" class="video-js vjs-default-skin" autoplay width="853" height="480" controls preload="auto" data-setup="{}">

		</video>
		<!-- <div id="vidPlayer"></div> -->
		<a href="#close" class="icon-remove"></a>
	</div>
</div>



<link href="css/video-js.css" rel="stylesheet">
<script src="js/video.js"></script>

<script type="text/javascript">
var dlQueue = []; //queue used for processing multiple downloads
var rmQueue = []; //queue used for processing multiple deletions
var rmBtnHtml = "";
var dnRetries = 0; //number of download retries
function Backuper (params) {
	this.hid = params.hid;
	this.holder = params.holder;
    // this.STAT_INIT = 0    //event initialized
    // this.STAT_START= 1<<0 //backup started
    // this.STAT_DONE = 1<<1 //backup done (success)
    // this.STAT_FAIL = 1<<2 //backup done (fail)
    // this.STAT_NOEVT= 1<<3 //event doesn't exist

	this.status = 0;
	return this;
	// var holder = obj.parents('.backup-holder');
	// 
	// ajaxCall("evtbackup/?event="+$(obj).attr('eventID'),null,function() {
	// 	holder.html('<i class="icon-ok green large"></i>')
	// });
}

Backuper.prototype.start = function() {
	var self = this;
	//display loading animation until copy starts
	this.holder.html('<img src="css/img/ajax-loader.gif"/>');
	// start the download
	ajaxCall("evtbackup/?event="+this.hid,"",
		function(){
			self.progress(); //start getting progress for the backup when server sends a response
		});
};

Backuper.prototype.progress = function() {
	var self = this;
	url = 'ajax/evtbackupstatus/?event='+self.hid+'&r='+Math.random();
	console.log(url);
	$.ajax({
		url: url,
		dataType: 'json'
		// data: {event: self.hid}
	})
	.done(function(data) {
		self.status = data[0];
		if((data[0]^16) && (data[0]&(2|4))){
			self.done();
		}
		else{//still backing up
			if(data[0]&1){ //backup started
				if(self.holder.find('.backup-meter').length<=0){ //just started backing up - display progress bar
					self.holder.html('<div class="meter animate backup-meter"><span style="width: 0%"><span></span></span></div>');
				}
				else{
					// update progress bar to the new progress
					pbarWidth(self.holder.find('.backup-meter > span'),data[1]);
				}
			}
			setTimeout(function(){
				self.progress();
			},1000); 
		}
	})
	.fail(function(jqxhr) {
		this.status = -1;
	})
	.always(function() {
	});
};

Backuper.prototype.done = function() {
	console.log(this.status);
	if(this.status==2){
	    // finished copying
		this.holder.html('<i class="icon-ok green large"></i>');
	}
	else{
		if(this.status & (1<<6)){
			this.holder.html('not enough space');
		}
		else if(this.status & (1<<5)){
			this.holder.html('no drives found');
		}
		else{
			this.holder.html('error '+this.status);
		}
	}
};

function getProgress() {
	// get download progress
	$.ajax({
		url: 'ajax/dlprogress',
		type: 'GET',
		success: function(data, textStatus, xhr){

			// response received for progress, get the % value
			data = eval("("+data+")");
			progress = parseInt(data['progress']);
			// set the progress bar width based on percentage
			pbarWidth(dlQueue[0].find('.meter > span'),progress);
			errorCode = parseInt(data['status']);
			if(progress>=100 || errorCode){ //file has finished or there was an error
				processQueue(true,errorCode);// file has finished - move on to the next one
			}
			else{
				setTimeout(getProgress,1000);//keep getting the progress every second until complete
			}
		}//end success
	});	
}

function rmQueueNext() {
	//remove the event that was just deleted
	deletedEvt = rmQueue.shift(); 
	// remove event row from the table
	$(deletedEvt).parents('.row').hide();
	if(rmQueue.length<1){
    	$('.removeSel').html(rmBtnHtml);
		return;
	}
	evtToDelete = rmQueue[0];

	$(evtToDelete).parents('.row').find('.vidColumn').html('<img src="css/img/ajax-loader.gif"/>');
	// send the call to delete the event
	ajaxCall("evtdelete/?name="+$(evtToDelete).attr('event')+"&event="+$(evtToDelete).attr('eventID'),"",rmQueueNext);
}
// process download queue
function processQueue(itemDone, itemError) {
	if(itemDone==undefined) itemDone=false;
	if(itemError==undefined) itemError=0;
	if(itemDone) { //just finished downloading an element - remove the progress bar
		switch(itemError){
			case -1: //idevcopy app crashed - retry download
				dnRetries++;
				if(dnRetries>3){
					status = 'Error - please retry';
				}
			break;
			case false:
			case 0:
				status = '<i class="icon-ok green large"></i>';
			break;
			case 1:
				status = 'not enough space';
			break;
			case 4:
				status = 'connect iPad via USB';
			break;
			case 7:
				dnRetries++;
				if(dnRetries>3){
					status = 'make sure you clicked TRUST this computer';
				}
				else{
					itemError = -1; //to make sure it retires downloading it
				}
			break;
			default: 
				status='error ('+itemError+')';
			break;
		}
		if(itemError>=0){
			dnRetries = 0;
			dlQueue[0].html(status); //either an error occurred or the progress has finished - put the status instead of the progress bar
			dlQueue.shift(); //remove the item that was completed (always the first one in the queue)
		}
	}
	if(itemError>=0){
		if(dlQueue.length<=0) {//no more items in the queue - all downloads are complete
			$('#download').removeAttr('disabled');
			$('#download').html('<i class="icon-download-alt"></i>');
			return; 
		}
		// grab the next video in the queue (first element)
		vid = dlQueue[0].find('input'); //dlqueue contains div's that contain checkboxes - hence the .find() method
		// get the name of the event (for ipad)
		evt = $(vid).attr('event');
		// replace checkbox with a progress bar
		dlQueue[0].html('<div class="meter animate"><span style="width: 0%"><span></span></span></div>'); //replace the checkbox
	}
	// send a request to download the file
	$.ajax({
	  url: 'ajax/prepdown',
	  data: {'event':evt},
	  success: function(data, textStatus, xhr){
	  	console.log(data);
		// $.ajax({
		//   url: 'dlstart.php',
		//   data: {'event':evt},
		//   success: function(data, textStatus, xhr){

		//     //called when successful - start checking for progress after 1 second
	    setTimeout(getProgress,2000);
		//   }
		// });
	  }
	});
}//end processQueue

function pbarWidth(obj,width) {
	obj.animate({
			width: width+'%'
		}, 500);
}
function fOnLoad (argument) {

	// warn user about exiting the page if the download is in progress
	window.onbeforeunload = function(e){
		if(dlQueue.length>0){
		    return 'If you leave this page, not all files may be downloaded and progress will not be updated for the current download.';
		}
	}
	// attach a click to the close button on a window
	$(document).on('click', '.wnd a[href$="close"]', function(e){
		e.preventDefault();
		$('html').find('.overlay').fadeOut(function (e) {
			$(this).remove();
		});
		$(this).parents('.wnd-container').fadeOut();
		videojs("#videoPlayer").pause();
		// jwplayer("vidPlayer").stop();
	});
	// attach media player to any media links (allows graceful breakdown for js-disabled cases)
    $('.media').click(function (e){
    	e.preventDefault();
	    self = this;
	    // html overlay
	    $('html').prepend("<div class='overlay hide'></div>");
	    $('.overlay').fadeIn();
	    // player window
	    $('#videoWnd').fadeIn();
	   	var vidType = $(self).attr('href').indexOf('.m3u8')>0?'application/x-mpegURL':'video/mp4';
	   	// remove any old videos
	   	$('#videoWnd video').find('source').remove();
	   	// add new video
	    $('#videoWnd video').append('<source src="'+$(self).attr('href')+'" type="'+vidType+'">');
		videojs("#videoPlayer").play();
    	return false;
    });
    // clicked download button
    $('#download').click(function(){
    	if(dlQueue.length>0 || rmQueue.length>0){ //do not allow download when download or deletion is in progress
    		return;
    	}
    	$(this).attr('disabled','disabled'); //make sure user cannot click download again
    	$(this).html('<img src="css/img/ajax-loader.gif"/>')
    	// go through every checked video (checkbox) and add it to the queue
    	$('input[download]:checked[control!=chkAll]').each(function (){
    		// add the parent div element of the checkbox to the queue (since checkbox will be replaced by progress bar)
    		dlQueue.push($(this).parent('div'));
    	}).attr('disabled','disabled');
    	console.log(dlQueue.length);
    	// start download
    	processQueue();
    });
    $('.removeSel').click(function (e){
    	e.preventDefault();
    	if(dlQueue.length>0 || rmQueue.length>0){
    		return;
    	}
    	// remove selected events
    	if(confirm('This will delete all the selected events. Are you sure?')){
	    	$('input:checked[control!=chkAll]').each(function (){
	    		rmQueue.push(this);
	    	});
	    	if(rmQueue.length>0){
		    	rmBtnHtml = $(this).html();
		    	$(this).html('<img src="css/img/ajax-loader.gif"/>');
		    	$(rmQueue[0]).parents('.row').find('.vidColumn').html('<img src="css/img/ajax-loader.gif"/>');
				// send the call to delete the event
				ajaxCall("evtdelete/?name="+$(rmQueue[0]).attr('event')+"&event="+$(rmQueue[0]).attr('eventID'),"",rmQueueNext);
			}
    	}//if confirm
    });//removeSel.click
    $('.removeEvt').click(function (e) {
    	e.preventDefault();
    	if(dlQueue.length>0 || rmQueue.length>0){
    		return;
    	}
    	var tableRow = this;
    	if(confirm('This will delete the event and the video. Are you sure?')){
	    	$(this).parents('.row').find('.vidColumn').html('<img src="css/img/ajax-loader.gif"/>');
    		ajaxCall("evtdelete/?name="+$(tableRow).attr('event')+"&event="+$(tableRow).attr('eventID'),"",
    			function(){
    				$(tableRow).parents('.row').hide();
    		});
    		// remove event row from the table
    		// $(this).parents('.row').hide();
    	}
    	return false;
    });//removeEvt.click
    $('.backupEvt').click(function(event) {
    	var hid = $(this).attr('eventID');
    	var holder = $(this).parents('.row').find('.vidColumn');
    	var backup = new Backuper({
    		hid:hid,
    		holder:holder
    	});
    	backup.start();

    });
    $('.chkAll:checkbox').change(function () {
    	if($(this).is(":checked")){
    		$(":checkbox").attr("checked","checked");
    	}
    	else{
    		$(":checkbox").removeAttr("checked");
    	}
    	return false;
    });
}//fOnLoad
</script>