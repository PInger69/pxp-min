@require(events)
<div class="col_12">
	<div class="row bold">
		<div class="col_2">Date</div>
		<div class="col_2">Home team</div>
		<div class="col_2">Visitor team</div>
		<div class="col_2">League</div>
		<div class="col_2">Video</div>
		<div class="col_2">
			<div class="cw_11 center">
				<button id="download" class="green small cw_12" type="reset">
				<i class="icon-download-alt"></i> download			
			</div>
			<div class="cw_1 right">
					<a href="#" class="removeSel large red"><i class="icon-remove"></i></a>
			</div>

<!-- 			<button id="download" class="green small cw_10 center" type="reset">
				<i class="icon-download-alt"></i> download
			</button>
			<div class="cw_1 right">
				<a href="#" class="removeEvt large red"><i class="icon-remove"></i></a>
			</div>
 -->
		</div>
	</div>	
@for ev in events:
	<div class="row border-top">
		<div class="col_2">
			@ev['date']
		</div>
		<div class="col_2">
			@ev['homeTeam']
		</div>
		<div class="col_2">
			@ev['visitTeam']
		</div>
		<div class="col_2">
			@ev['league']
		</div>
		<div class="col_2">
			@if 'mp4' in ev:
				<a class="media" href="@ev['mp4']">play</a> (@ev['vid_size'])
			@elif 'live' in ev:
				<a class="media" href="@ev['live']">live</a>
			@else:
				n/a
			@end
		</div>
		<div class="col_2">
			<div class="cw_11 center">
				@if 'mp4' in ev:
					<input type="checkbox" class="center" event="@ev['name']" eventID="@ev['hid']">
				@else:
					&nbsp;
				@end
			</div>
			<div class="cw_1 right">
				@if not 'live' in ev:
					<a href="#" class="removeEvt large red" event="@ev['name']" eventID="@ev['hid']"><i class="icon-remove"></i></a>
				@end
			</div>
		</div>
	</div>
@end
</div>
<div id="videoWnd" class="wnd-container hide">
	<div class="wnd">
		<div id="vidPlayer"></div>
		<a href="#close" class="icon-remove"></a>
	</div>
</div>



<script type="text/javascript" src="js/jwplayer.js"></script>
<script type="text/javascript">
var dlQueue = []; //queue used for processing multiple downloads
var rmQueue = []; //queue used for processing multiple deletions
function getProgress() {
	// get download progress
	$.ajax({
		url: 'ajax/dlprogress',
		type: 'GET',
		success: function(data, textStatus, xhr){
			console.log(data);
			// response received for progress, get the % value
			data = eval("("+data+")");
			progress = parseInt(data['progress']);
			// set the progress bar width based on percentage
			pbarWidth(dlQueue[0].find('.meter > span'),progress);
			errorCode = parseInt(data['status']);
			if(progress>=100 || errorCode){ //file has finished or there was an error
				processQueue(true,errorCode);// file has finished - move on to the next one
			}
			else{
				setTimeout(getProgress,1000);//keep getting the progress every second until complete
			}
		}//end success
	});	
}

function rmQueueNext() {
	if(rmQueue.length<1){
		return;
	}
	obj = rmQueue.pop();
	// remove event row from the table
	$(obj).parents('.row').hide();
	// send the call to delete the event
	ajaxCall("evtdelete/?name="+$(obj).attr('event')+"&event="+$(obj).attr('eventID'),"",rmQueueNext);

}
// process download queue
function processQueue(itemDone, itemError) {
	if(itemDone==undefined) itemDone=false;
	if(itemError==undefined) itemError=0;
	if(itemDone) { //just finished downloading an element - remove the progress bar
		switch(itemError){
			case -1: //idevcopy app crashed - retry download
			break;
			case false:
			case 0:
				status = '<i class="icon-ok green large"></i>';
			break;
			case 1:
				status = 'not enough space';
			break;
			case 4:
				status = 'connect iPad via USB';
			break;
			default: 
				status='error ('+itemError+')';
			break;
		}
		if(itemError>=0){
			dlQueue[0].html(status); //either an error occurred or the progress has finished - put the status instead of the progress bar
			dlQueue.shift(); //remove the item that was completed (always the first one in the queue)
		}
	}
	if(itemError>=0){
		if(dlQueue.length<=0) {//no more items in the queue - all downloads are complete
			$('#download').removeAttr('disabled');
			$('#download').html('<i class="icon-download-alt"></i> download');
			return; 
		}
		// grab the next video in the queue (first element)
		vid = dlQueue[0].find('input'); //dlqueue contains div's that contain checkboxes - hence the .find() method
		// get the name of the event (for ipad)
		evt = $(vid).attr('event');
		// replace checkbox with a progress bar
		dlQueue[0].html('<div class="meter animate"><span style="width: 0%"><span></span></span></div>'); //replace the checkbox
	}
	// send a request to download the file
	$.ajax({
	  url: 'ajax/prepdown',
	  data: {'event':evt},
	  success: function(data, textStatus, xhr){
	  	console.log(data);
		$.ajax({
		  url: 'dlstart.php',
		  data: {'event':evt},
		  success: function(data, textStatus, xhr){
		  	console.log(data);
		    //called when successful - start checking for progress after 1 second
		    setTimeout(getProgress,1000);
		  }
		});
	  }
	});
}//end processQueue

function pbarWidth(obj,width) {
	obj.animate({
			width: width+'%'
		}, 500);
}
function fOnLoad (argument) {

	// warn user about exiting the page if the download is in progress
	window.onbeforeunload = function(e){
		if(dlQueue.length>0){
		    return 'If you leave this page, not all files may be downloaded and progress will not be updated for the current download.';
		}
	}
	// attach a click to the close button on a window
	$('.wnd a[href$="close"]').live('click', function(e){
		e.preventDefault();
		$('html').find('.overlay').fadeOut(function (e) {
			$(this).remove();
		});
		$(this).parents('.wnd-container').fadeOut();
	});
	// attach media player to any media links (allows graceful breakdown for js-disabled cases)
    $('.media').click(function (e){
    	e.preventDefault();
	    self = this;
	    // html overlay
	    $('html').prepend("<div class='overlay hide'></div>");
	    $('.overlay').fadeIn();
	    // player window
	    $('#videoWnd').fadeIn();
	    // initialize the player to 480p resolution
	    jwplayer("vidPlayer").setup({
	        file: $(self).attr('href'),
	        width: 853,
	        height: 480,
	        analytics: {
	        	enabled:false,
	        	cookies:false
	        }
	    });	
	    // start playing
	    jwplayer("vidPlayer").play();
    	return false;
    });
    // clicked download button
    $('#download').click(function(){
    	$(this).attr('disabled','disabled'); //make sure user cannot click download again
    	$(this).html('<img src="css/img/ajax-loader.gif"/>')
    	// go through every checked video (checkbox) and add it to the queue
    	$('input:checked').each(function (){
    		// add the parent div element of the checkbox to the queue (since checkbox will be replaced by progress bar)
    		dlQueue.push($(this).parent('div'));
    	}).attr('disabled','disabled');
    	// start download
    	processQueue();

    });
    $('.removeSel').click(function (e){
    	e.preventDefault();
    	if(dlQueue.length>0){
    		return;
    	}
    	// remove selected events
    	if(confirm('This will delete all the selected events. Are you sure?')){
	    	$('input:checked').each(function (){
	    		rmQueue.push(this);
	    	});
	    	rmQueueNext();
    	}//if confirm
    });//removeSel.click
    $('.removeEvt').click(function (e) {
    	e.preventDefault();
    	if(dlQueue.length>0){
    		return;
    	}
    	if(confirm('This will delete the event and the video. Are you sure?')){
    		ajaxCall("evtdelete/?name="+$(this).attr('event')+"&event="+$(this).attr('eventID'));
    		// remove event row from the table
    		$(this).parents('.row').hide();
    	}
    	return false;
    });//removeEvt.click
}//fOnLoad
</script>