<!-- ===================================== START FOOTER ===================================== -->
		<div class="clear"></div>
		<div id="footer">
		&copy; 2013 Avoca Technologies Inc.
		</div>
	</div><!-- END WRAP -->
</div><!-- END GRID -->
<script type="text/javascript">
	var cameraStateTmr = null;     	//timer variable (used to reset it if need be)
	var encStatus = ""; 	//encoder status: live, off, paused
	var btnHtml = "";   	//html for the submit button prior to clicking
	var ajaxInProgress = false;	//whether the page can be reloaded - true if there is an ajax call in progress
	var shutDownCounter = 0; //counts after receiving an error from the server (happens when server goes offline)
	var shuttingDown = false;
	function ajaxSubmit(form, callback){
		if(callback==undefined){
			callback = false;
		}
		// $(form).find('input, select').removeClass('alert');
		// show the loading wheel
		// $(form).find('#loader').show();
		//reset the warning on the form
		// $(form).find("#msg").html(''); 

		timestamp = new Date(); //added to prevent response caching on Safari (great job Apple! #fail )
		$(form).find('.warning').hide();
		action = $(form).attr('action');
		post_data = $(form).serialize()+"&timestamp="+timestamp.getTime();
		ajaxInProgress = true;
		$.ajax({
		    url: 'ajax/'+action,
		    type: 'POST',
		    data: post_data,
		    success: function(data, textStatus, xhr){
				//response from the server received
				console.log(data);
				ajaxInProgress = false;
				try{
					rez = eval("("+data+")");//parse json
				}
				catch(e){
					rez = { };
					rez.success = false;
					rez.msg = data;
					rez.action = '';
				}
				if(rez.success){
					if(callback){
						eval(callback+"();");
					}
					// reset all the fields
					// $('#'+form)[0].reset();
				}
				else{
					$(form).find('.warning .status').html(rez.msg);
					$(form).find('.warning').show();
				}//if rez.success else
				// reset the submit button state to what it was before the submission
				$(form).find('button[type="submit"]').html(btnHtml).removeAttr('disabled');
		    },//on success
		    error: function(xhr, textStatus, errorThrown){
				//called when there is an error
				console.log(textStatus)
				ajaxInProgress = false;
				$(form).find('button[type="submit"]').html(btnHtml).removeAttr('disabled');
		    }
		});
	}//ajaxSubmit
	function ajaxCall(action,params,callback){
		if(params==undefined){
			params = "";
		}
		if(callback==undefined){
			callback = false;
		}
		try{
			//params contains the list of IDs of elements whose values should be passed as parameters
			// perform the ajax request
			//eval("("+params+")");
			pr = params.split(',');
		}
		catch(e){
			pr = new Array();
		}
		// console.log(pr);
		// return;
		ajaxInProgress = true;
		shuttingDown = action=='encshutdown';
		params = {};
		for(elem in pr){
			// console.log(pr[elem]);
			params[pr[elem]] = $('#'+pr[elem]).val();
		}
		// console.log(params);;
		$.ajax({
		  url: 'ajax/'+action,
		  data: params,
		  success: function(data, textStatus, xhr) {
		    console.log(data);
		    res = { };
		    try{
		    	res = eval("("+data+")");
		    }
		    catch(e){
		    	res['success'] = false;
		    }
		    console.log(res);
		    if (!res['success'] && shuttingDown){
		  		shuttingDown = false;
		  		alert('user permissions do not allow encoder shut down');
		  		window.location.reload();
		    }
	    	switch(res['action']){
	    		case 'reload': 	
	    			window.location.reload();
	    		break;
	    		default :	    		
	    		break;

	    	}	    	
		    ajaxInProgress = false;
		    if(res['success'] && callback!=false){
		    	console.log('call');
		    	callback();
		    }
		  },
		  error: function(xhr, textStatus, errorThrown) {
		  	// if (shuttingDown){
		  	// 	shuttingDown = false;
		  	// 	alert('user permissions do not allow encoder shut down');
		  	// }
		    console.log(textStatus);
		    ajaxInProgress = false;
		  }
		});
	}
	// periodically get the camera status
	function ajaxCamStatus(){
		// check if the camera is connected and set the status accordingly
		$.ajax({
		  url: 'ajax/getcamera',
		  success: function(data, textStatus, xhr) {
			// console.log(data);
			try{
				rez = eval("("+data+")");//parse json
			}
			catch(e){
				rez = { };
				rez.success = false;
				rez.msg = data;
			}
			if (rez.success){
				// got a proper response from the server - put the message as camera status
				if(rez.msg=='No camera'){
					$('#cam-status').text('N/A');
				}
				else{
					$('#cam-status').text(rez.msg);
				}
				if(rez.encoder!=encStatus){
					clearTimeout(cameraStateTmr);
					if (!ajaxInProgress){
						window.location.reload();
					}
				}
			}
			cameraStateTmr = setTimeout(ajaxCamStatus,2000); //check camera status continuously
		  },
		  error: function(xhr, textStatus, errorThrown) {
		  	if (shutDownCounter>9){//after a few seconds the encoder should be off 
			    $('html').prepend("<div class='overlay hide'></div>");
			    $('.overlay').fadeIn();
			    $('#shutdownNotice').fadeIn();
		  		return;
		  	}
		  	if(shuttingDown){
		  		shutDownCounter++;
		  	}
			cameraStateTmr = setTimeout(ajaxCamStatus,2000); //error occurred - keep checking the status
		    console.log(textStatus);
		  }
		});
	}
	// get encoder status (live/paused/off)
	$(function(){
		// if there was an onLoad function defined in one of the html's - run it
		if(typeof fOnLoad=='undefined'){
			fOnLoad = function (){ };
        }
        fOnLoad();
        // attach ajax submit to the forms
        $('form').submit(function(){
        	if(!$(this).attr('default')){
        		// disable submit button to prevent it from submitting again        		
        		btnSubmit = $(this).find('button[type="submit"]');
				btnSubmit.attr('disabled','disabled');
				btnHtml = btnSubmit.html();
				// add ajax loader image
				btnSubmit.html('<img src="css/img/ajax-loader.gif"/>');
				// perform the submit
	        	ajaxSubmit(this,$(this).attr('callback'));
	        	return false;
	        }
        });
		$('.ajaxbtn').click(function(e) {
			// disable the ajax button to prevent further submissions
			$(this).attr('disabled','disabled');
			// show loader image
			$(this).html('<img src="css/img/ajax-loader.gif"/>');
			// ajax buttons have 'action' attribute which is the name of the url to call
			// some have param attribute - list of #id's of elements whose values to add to the call
			ajaxCall($(this).attr('action'),$(this).attr('param'));
		});
	});
</script>
</body>
</html>